<!-- -*- mode: jinja2 -*- -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="description" content="Air quality dispersion model for high resolution downscaling of EMEP-MSC-W">
    <meta name="author" content="" >
    <link rel="icon" href="../favicon.png">

    <title>uEMEP_save_netcdf_control &ndash; uEMEP</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
      <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>
  </head>

  <body>

    <!-- Fixed navbar -->
    <div class="container-fluid mb-sm-4 mb-xl-2">
      <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
          <a class="navbar-brand" href="../index.html">uEMEP </a>
          <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar"
                  aria-expanded="false" aria-controls="navbar" aria-label="Toggle navigation">
                  <span class="navbar-toggler-icon">
          </button>

          <div id="navbar" class="navbar-collapse collapse">
            <ul class="navbar-nav">
                <li class="nav-item"><a class="nav-link" href="../page/index.html">Model Documentation</a></li>
                  <li class="nav-item">
                    <a class="nav-link" href="../lists/files.html">Source Files</a>
                  </li>
                <li class="nav-item">
                  <a class="nav-link" href="../lists/modules.html">Modules</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../lists/procedures.html">Procedures</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../program/uemep_v6.html">Program</a>
                </li>
            </ul>
              <div class="d-flex align-items-end flex-grow-1">
                <form action="../search.html" role="search" class="ms-auto">
                  <input type="text" class="form-control" aria-label="Search" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
                </form>
              </div>
          </div><!--/.nav-collapse -->
        </div>
      </nav>
    </div>

    <div class="container">
  <div class="row">
    <h1>uEMEP_save_netcdf_control
      <small>Subroutine</small>
      
    </h1>
      <div class="container p-2 mb-4 bg-light border rounded-3">
    <div class="row align-items-center justify-content-between" id="info-bar">
      <div class="col">
        <ul class="list-inline" style="margin-bottom:0px;display:inline">

            <li class="list-inline-item" id="statements"><i class="fa fa-list-ol"></i>
              <a data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-html="true"
                 title=" 7.0% of total for procedures.">1390 statements</a>
            </li>

            <li class="list-inline-item" id="source-file">
              <i class="fa fa-code"></i>
              <a href="../src/uEMEP_save_netcdf_file.f90"> Source File</a>
            </li>
        </ul>
      </div>
      <div class="col">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb justify-content-end mb-0">
                <li class="breadcrumb-item"><a href='../sourcefile/uemep_save_netcdf_file.f90.html'>uEMEP_save_netcdf_file.f90</a></li>
                <li class="breadcrumb-item"><a href='../module/save_netcdf_file.html'>save_netcdf_file</a></li>
            <li class="breadcrumb-item active" aria-current="page">uEMEP_save_netcdf_control</li>
          </ol>
        </nav>
      </div>
    </div>
  </div>
  <script>
    $(function () {
    $('[data-bs-toggle="tooltip"]').tooltip()
    })
  </script>

  </div>
  
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
      <div id="sidebar">
      <h3>Contents</h3>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    <div class="card card-primary">
      <div class="card-header text-left"><h3 class="card-title">Source Code</h3></div>
      <div class="list-group">
        <a class="list-group-item" href="../proc/uemep_save_netcdf_control.html#src">uEMEP_save_netcdf_control</a>
      </div>
    </div>


  </div>

    </div>
    
    <div class="col-md-9" id='text'>
    <h2>public  subroutine uEMEP_save_netcdf_control()  
</h2>
        <div class="card mb-4">
      <h3 class="card-header card-title bg-light">Uses</h3>
      <div class="card-body">
        <ul class="list-group list-group-flush">
            <li class="list-group-item">
              <ul class="list-inline">
                  <li class="list-inline-item"><a href='../module/uemep_definitions.html'>uEMEP_definitions</a></li>
              </ul>
            </li>
        </ul>
      </div>
    </div>


    <p>.or. use_region_select_and_mask_flag ??
!!!!! what to write here???</p>


    <h3>Arguments</h3>
    <em>None</em>
    <br>
    <br>


    
    

    
    



    
    <section>
    <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="hl codehilite"><pre><span></span><span class="w">    </span><span class="k">subroutine </span><span class="n">uEMEP_save_netcdf_control</span>

<span class="w">        </span><span class="k">use </span><span class="n">uEMEP_definitions</span>

<span class="w">        </span><span class="k">implicit none</span>

<span class="k">        </span><span class="kt">integer </span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">l</span>
<span class="w">        </span><span class="kt">integer </span><span class="n">i_comp</span><span class="p">,</span><span class="n">i_file</span><span class="p">,</span><span class="n">i_meteo</span>
<span class="w">        </span><span class="kt">character</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="n">temp_name</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="w"> </span><span class="n">temp_date_str</span><span class="p">,</span><span class="n">station_name_str</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">temp_compound_str</span>
<span class="w">        </span><span class="kt">logical </span><span class="n">create_file</span><span class="p">,</span><span class="n">create_file_rec</span>
<span class="w">        </span><span class="kt">integer </span><span class="n">i_source</span>
<span class="w">        </span><span class="kt">real</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">valid_min</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">        </span><span class="kt">real</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">temp_subgrid</span><span class="p">(:,:,:)</span>
<span class="w">        </span><span class="kt">real</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">temp_integral_subgrid</span><span class="p">(:,:,:)</span>
<span class="w">        </span><span class="kt">real</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">aqi_subgrid</span><span class="p">(:,:,:,:)</span>
<span class="w">        </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">aqi_responsible_pollutant_index</span><span class="p">(:,:,:)</span>
<span class="w">        </span><span class="kt">real</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">temp_subgrid_ascii</span><span class="p">(:,:)</span>

<span class="w">        </span><span class="kt">integer </span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">tt</span>

<span class="w">        </span><span class="kt">real </span><span class="n">aqi_limits_temp</span><span class="p">(</span><span class="n">n_compound_index</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>
<span class="w">        </span><span class="kt">real </span><span class="n">max_aqi</span>
<span class="w">        </span><span class="kt">integer </span><span class="n">n_aqi_pollutant_index</span>
<span class="w">        </span><span class="k">parameter</span><span class="w"> </span><span class="p">(</span><span class="n">n_aqi_pollutant_index</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="w">        </span><span class="kt">integer </span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="n">n_aqi_pollutant_index</span><span class="p">)</span>
<span class="w">        </span><span class="kt">integer </span><span class="n">i_pollutant</span><span class="p">,</span><span class="n">i_loop</span>
<span class="w">        </span><span class="kt">character</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="n">variable_type</span>
<span class="w">        </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">receptor_available</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.</span>
<span class="w">        </span><span class="kt">real </span><span class="n">scale_factor</span>
<span class="w">        </span><span class="kt">integer </span><span class="n">n_save_aqi_pollutant_index</span>
<span class="w">        </span><span class="kt">real </span><span class="n">temp_sum_comp</span>
<span class="w">        </span><span class="kt">integer </span><span class="nb">count</span>
<span class="nb">        </span><span class="kt">character</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="n">filename_ascii</span>

<span class="w">        </span><span class="kt">integer </span><span class="n">i_sp</span><span class="p">,</span><span class="n">ii_sp</span>

<span class="w">        </span><span class="kt">integer </span><span class="n">source_domain_loop</span>
<span class="w">        </span><span class="kt">integer </span><span class="n">no2_o3_loop</span><span class="p">,</span><span class="n">comp_index</span><span class="p">,</span><span class="n">comp_nc_index</span>
<span class="w">        </span><span class="kt">character</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="n">filename_append</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">include_o3_in_aqi_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            </span><span class="n">n_save_aqi_pollutant_index</span><span class="o">=</span><span class="n">n_aqi_pollutant_index</span>
<span class="w">        </span><span class="k">else</span>
<span class="k">            </span><span class="n">n_save_aqi_pollutant_index</span><span class="o">=</span><span class="n">n_aqi_pollutant_index</span><span class="o">-</span><span class="mi">1</span>
<span class="w">        </span><span class="k">endif</span>

<span class="k">        if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">))</span><span class="w"> </span><span class="k">allocate</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)))</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">temp_integral_subgrid</span><span class="p">))</span><span class="w"> </span><span class="k">allocate</span><span class="p">(</span><span class="n">temp_integral_subgrid</span><span class="p">(</span><span class="n">integral_subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">integral_subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)))</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">aqi_subgrid</span><span class="p">).</span><span class="nb">and</span><span class="p">.</span><span class="n">save_aqi</span><span class="p">)</span><span class="w"> </span><span class="k">allocate</span><span class="p">(</span><span class="n">aqi_subgrid</span><span class="p">(</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">),</span><span class="n">n_compound_index</span><span class="p">))</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">aqi_responsible_pollutant_index</span><span class="p">).</span><span class="nb">and</span><span class="p">.</span><span class="n">save_aqi</span><span class="p">)</span><span class="w"> </span><span class="k">allocate</span><span class="p">(</span><span class="n">aqi_responsible_pollutant_index</span><span class="p">(</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)))</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">temp_subgrid_ascii</span><span class="p">).</span><span class="nb">and</span><span class="p">.</span><span class="n">save_compounds_as_ascii</span><span class="p">)</span><span class="w"> </span><span class="k">allocate</span><span class="p">(</span><span class="n">temp_subgrid_ascii</span><span class="p">(</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)))</span>

<span class="w">        </span><span class="c">!Save subgrid calculations</span>
<span class="w">        </span><span class="n">valid_min</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">        </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;ug/m3&quot;</span>
<span class="w">        </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;byte&#39;</span>
<span class="w">        </span><span class="c">!variable_type=&#39;double&#39;</span>
<span class="w">        </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">        </span><span class="n">scale_factor</span><span class="o">=</span><span class="mf">1.</span>

<span class="w">        </span><span class="c">!Save the data</span>
<span class="w">        </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_total_file_index</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">)</span>
<span class="w">        </span><span class="c">!temp_name=trim(pathname_grid(i_file))//trim(filename_grid(i_file))//&#39;_&#39;//trim(file_tag)//&#39;.nc&#39;</span>
<span class="w">        </span><span class="c">!if (len(config_date_str).gt.0) then</span>
<span class="w">        </span><span class="c">!    temp_date_str=&#39;_&#39;//trim(config_date_str)</span>
<span class="w">        </span><span class="c">!else</span>
<span class="w">        </span><span class="c">!    temp_date_str=&#39;&#39;</span>
<span class="w">        </span><span class="c">!endif</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filename_date_output_grid</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            </span><span class="n">temp_date_str</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="o">//</span><span class="n">filename_date_output_grid</span>
<span class="w">        </span><span class="k">else</span>
<span class="k">            </span><span class="n">temp_date_str</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
<span class="w">        </span><span class="k">endif</span>

<span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="n">use_multiple_receptor_grids_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            </span><span class="n">station_name_str</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">name_receptor_in</span><span class="p">(</span><span class="n">g_loop</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="k">else</span>
<span class="k">            </span><span class="n">station_name_str</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
<span class="w">        </span><span class="k">endif</span>

<span class="w">        </span><span class="c">!Do not write &#39;all&#39; in file name if all compounds are selected</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pollutant_index</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">all_nc_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            </span><span class="n">temp_compound_str</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
<span class="w">        </span><span class="k">else</span>
<span class="k">            </span><span class="n">temp_compound_str</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">compound_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">))</span>
<span class="w">        </span><span class="k">endif</span>
<span class="w">        </span><span class="c">!Do not write anything about the compounds</span>
<span class="w">        </span><span class="n">temp_compound_str</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

<span class="w">        </span><span class="c">!temp_name=trim(pathname_grid(i_file))//trim(station_name_str)//&#39;uEMEP_&#39;//trim(file_tag)//trim(temp_compound_str)//trim(temp_date_str)//&#39;_&#39;//trim(forecast_hour_str)//&#39;.nc&#39;</span>
<span class="w">        </span><span class="c">!temp_name_rec=trim(pathname_grid(i_file))//&#39;uEMEP_&#39;//trim(file_tag)//&#39;_station&#39;//trim(temp_compound_str)//trim(temp_date_str)//&#39;_&#39;//trim(forecast_hour_str)//&#39;.nc&#39;</span>
<span class="w">        </span><span class="c">!if (save_netcdf_average_flag) then</span>
<span class="w">        </span><span class="c">!temp_name=trim(pathname_grid(i_file))//trim(station_name_str)//&#39;uEMEP_&#39;//trim(file_tag)//trim(temp_compound_str)//&#39;_mean&#39;//trim(temp_date_str)//&#39;_&#39;//trim(forecast_hour_str)//&#39;.nc&#39;</span>
<span class="w">        </span><span class="c">!temp_name_rec=trim(pathname_grid(i_file))//&#39;uEMEP_&#39;//trim(file_tag)//&#39;_station&#39;//trim(temp_compound_str)//&#39;_mean&#39;//trim(temp_date_str)//&#39;_&#39;//trim(forecast_hour_str)//&#39;.nc&#39;</span>
<span class="w">        </span><span class="c">!endif</span>
<span class="w">        </span><span class="n">temp_name</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">pathname_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">station_name_str</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;uEMEP_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">file_tag</span><span class="p">)</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_compound_str</span><span class="p">)</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_date_str</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span>
<span class="w">        </span><span class="n">temp_name_rec</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">pathname_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;uEMEP_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">file_tag</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;_station&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_compound_str</span><span class="p">)</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_date_str</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_average_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            </span><span class="n">temp_name</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">pathname_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">station_name_str</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;uEMEP_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">file_tag</span><span class="p">)</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_compound_str</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;_mean&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_date_str</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span>
<span class="w">            </span><span class="n">temp_name_rec</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">pathname_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;uEMEP_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">file_tag</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;_station&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_compound_str</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;_mean&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_date_str</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span>
<span class="w">        </span><span class="k">endif</span>

<span class="k">        </span><span class="n">finished_file</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">pathname_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">finished_subpath</span><span class="p">)</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">station_name_str</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;uEMEP_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">file_tag</span><span class="p">)</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_compound_str</span><span class="p">)</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_date_str</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">finished_filename</span><span class="p">)</span>
<span class="w">        </span><span class="n">finished_file_rec</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">pathname_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">finished_subpath</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;uEMEP_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">file_tag</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;_station&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_compound_str</span><span class="p">)</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_date_str</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">finished_filename</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_average_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            </span><span class="n">finished_file</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">pathname_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">finished_subpath</span><span class="p">)</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">station_name_str</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;uEMEP_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">file_tag</span><span class="p">)</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_compound_str</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;_mean&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_date_str</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">finished_filename</span><span class="p">)</span>
<span class="w">            </span><span class="n">finished_file_rec</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">pathname_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">finished_subpath</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;uEMEP_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">file_tag</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;_station&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_compound_str</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;_mean&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_date_str</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">finished_filename</span><span class="p">)</span>
<span class="w">        </span><span class="k">endif</span>

<span class="k">        write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<span class="w">        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;================================================================&#39;</span>
<span class="w">        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Saving netcdf data (uEMEP_save_netcdf_control)&#39;</span>
<span class="w">        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;================================================================&#39;</span>

<span class="w">        </span><span class="n">i_comp</span><span class="o">=</span><span class="mi">1</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">i_comp</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mf">1.</span><span class="nb">and</span><span class="p">.</span><span class="n">t_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">start_time_loop_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;No receptor positions available. Will not save receptor data.&#39;</span>
<span class="w">                </span><span class="n">receptor_available</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">        endif</span>

<span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_average_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">val_array_av</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">                allocate</span><span class="p">(</span><span class="n">val_array_av</span><span class="p">(</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">n_var_av</span><span class="p">))</span>
<span class="w">                </span><span class="n">val_array_av</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">time_seconds_output_av</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">                allocate</span><span class="p">(</span><span class="n">time_seconds_output_av</span><span class="p">(</span><span class="n">n_var_av</span><span class="p">))</span>
<span class="w">                </span><span class="n">time_seconds_output_av</span><span class="o">=</span><span class="mi">0</span>
<span class="w">            </span><span class="k">endif</span>
<span class="w">            </span><span class="c">!Reset average file counter for every time step saving occurs</span>
<span class="w">            </span><span class="n">counter_av</span><span class="o">=</span><span class="mi">0</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Saving as mean data&#39;</span>
<span class="w">        </span><span class="k">endif</span>

<span class="w">        </span><span class="c">!Save the final result of the subgrid calculation in ascii format</span>
<span class="w">        </span><span class="c">!This should only be used for annual mean calculations since it cannot have a time dimmension</span>
<span class="w">        </span><span class="c">!Intended for FAIRMODE output</span>
<span class="w">        </span><span class="c">!Makes a new file for each compound and averages over time, if there is a time dimension</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_compounds_as_ascii</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;ug/m3&quot;</span>
<span class="w">            </span><span class="k">do </span><span class="n">i_pollutant</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_pollutant_loop</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pmex_index</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pm25_sand_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pm10_sand_index</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pm25_salt_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pm10_salt_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    do </span><span class="n">i_loop</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_pollutant_compound_loop</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">)</span>

<span class="w">                        </span><span class="n">i_comp</span><span class="o">=</span><span class="n">pollutant_compound_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">,</span><span class="n">i_loop</span><span class="p">)</span>
<span class="w">                        </span><span class="c">!write(*,*) i_comp</span>

<span class="w">                        </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">i_comp</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">))</span>

<span class="w">                        </span><span class="n">title_str</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">file_tag</span><span class="p">)</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_date_str</span><span class="p">)</span>
<span class="w">                        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing ascii data to: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">title_str</span><span class="p">)</span>

<span class="w">                        </span><span class="n">filename_ascii</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">pathname_output_grid</span><span class="p">)</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">title_str</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.asc&#39;</span>

<span class="w">                        </span><span class="n">temp_subgrid_ascii</span><span class="p">(:,:)</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">comp_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span>


<span class="w">                        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing ascii array variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">comp_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">))</span><span class="o">/</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span><span class="o">/</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span><span class="o">/</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span>

<span class="w">                        </span><span class="k">call </span><span class="n">write_esri_ascii_file</span><span class="p">(</span><span class="n">filename_ascii</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_delta</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">temp_subgrid_ascii</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">)</span>

<span class="w">                    </span><span class="k">enddo</span>
<span class="k">                endif</span>
<span class="k">            enddo</span>
<span class="k">        endif</span>

<span class="w">        </span><span class="c">!Save the final result of the subgrid calculation</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_compounds</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>

<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving all total compounds&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>

<span class="w">            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;ug/m3&quot;</span>
<span class="w">            </span><span class="k">do </span><span class="n">i_pollutant</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_pollutant_loop</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pmex_index</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pm25_sand_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pm10_sand_index</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pm25_salt_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pm10_salt_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    do </span><span class="n">i_loop</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_pollutant_compound_loop</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">)</span>

<span class="w">                        </span><span class="n">i_comp</span><span class="o">=</span><span class="n">pollutant_compound_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">,</span><span class="n">i_loop</span><span class="p">)</span>
<span class="w">                        </span><span class="c">!write(*,*) i_comp</span>

<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mf">1.</span><span class="nb">and</span><span class="p">.</span><span class="n">i_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mf">1.</span><span class="nb">and</span><span class="p">.</span><span class="n">t_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">start_time_loop_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                            </span><span class="n">create_file</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.</span>
<span class="w">                            </span><span class="n">title_str</span><span class="o">=</span><span class="s1">&#39;uEMEP_concentration_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">file_tag</span><span class="p">)</span><span class="o">//</span><span class="n">temp_date_str</span>
<span class="w">                            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing to: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_name</span><span class="p">)</span>
<span class="w">                        </span><span class="k">else</span>
<span class="k">                            </span><span class="n">create_file</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">                        </span><span class="k">endif</span>

<span class="k">                        if</span><span class="w"> </span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mf">1.</span><span class="nb">and</span><span class="p">.</span><span class="n">i_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mf">1.</span><span class="nb">and</span><span class="p">.</span><span class="n">t_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">start_time_loop_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">first_g_loop</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">save_netcdf_receptor_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                            </span><span class="n">create_file_rec</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.</span>
<span class="w">                            </span><span class="n">title_str_rec</span><span class="o">=</span><span class="s1">&#39;uEMEP_receptor_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">file_tag</span><span class="p">)</span><span class="o">//</span><span class="n">temp_date_str</span>
<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">receptor_available</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing to: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_name_rec</span><span class="p">)</span>
<span class="w">                        </span><span class="k">else</span>
<span class="k">                            </span><span class="n">create_file_rec</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">                        </span><span class="k">endif</span>

<span class="k">                        </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">i_comp</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_concentration&#39;</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                            </span><span class="n">temp_sum_comp</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">                            </span><span class="nb">count</span><span class="o">=</span><span class="mi">0</span>
<span class="w">                            </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                                </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">use_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                        </span><span class="n">temp_sum_comp</span><span class="o">=</span><span class="n">temp_sum_comp</span><span class="o">+</span><span class="nb">sum</span><span class="p">(</span><span class="n">comp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:,</span><span class="n">i_comp</span><span class="p">))</span><span class="o">/</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span>
<span class="w">                                        </span><span class="nb">count</span><span class="o">=</span><span class="nb">count</span><span class="o">+</span><span class="mi">1</span>
<span class="w">                                    </span><span class="k">endif</span>
<span class="k">                                enddo</span>
<span class="k">                            enddo</span>
<span class="k">                            if</span><span class="w"> </span><span class="p">(</span><span class="nb">count</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                </span><span class="n">temp_sum_comp</span><span class="o">=</span><span class="n">temp_sum_comp</span><span class="o">/</span><span class="nb">count</span>
<span class="nb">                            </span><span class="k">else</span>
<span class="k">                                </span><span class="n">temp_sum_comp</span><span class="o">=</span><span class="mi">0</span>
<span class="w">                            </span><span class="k">endif</span>
<span class="w">                            </span><span class="c">!write(unit_logfile,&#39;(a,f12.3)&#39;)&#39;Writing netcdf array variable:    &#39;//trim(var_name_temp),temp_sum_comp</span>
<span class="w">                            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">comp_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">),</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">comp_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">comp_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">),</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">comp_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                            </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">comp_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                        </span><span class="k">endif</span>
<span class="k">                        if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">comp_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">),</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">comp_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">comp_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">),</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">comp_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                            </span><span class="c">!write(unit_logfile,&#39;(a,f12.3)&#39;)&#39;Writing netcdf receptor variable: &#39;//trim(var_name_temp),sum(comp_subgrid(:,:,:,i_comp))/subgrid_dim(x_dim_index)/subgrid_dim(y_dim_index)/subgrid_dim(t_dim_index)</span>
<span class="w">                            </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">comp_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                        </span><span class="k">endif</span>
<span class="k">                    enddo</span>
<span class="k">                endif</span>
<span class="k">            enddo</span>

<span class="k">        endif</span>

<span class="k">        </span><span class="n">create_file</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">        </span><span class="n">create_file_rec</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.</span>

<span class="w">        </span><span class="c">! Save downscaled source contributions for pollutants (not no2 or o3)</span>
<span class="w">        </span><span class="c">! 1 = local</span>
<span class="w">        </span><span class="c">! 2 = local, cut down to from_in_region</span>
<span class="w">        </span><span class="c">! 3-4: not used here, but kept to make numbering consistent with the other loops over source_domain_loop</span>
<span class="w">        </span><span class="c">! 5 = total: contribution from big domain, but using downscaled within moving window: 1 + (additional_emep_local(3) - emep_local(1)</span>
<span class="w">        </span><span class="c">! 6 = total from in region = 2 + semilocal emep contribution (4))</span>
<span class="w">        </span><span class="k">do </span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span>

<span class="w">            </span><span class="c">! Skip this round in the loop if this type of source contributions are not to be saved</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">save_source_contributions</span><span class="p">)</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">                </span><span class="n">filename_append</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
<span class="w">            </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">trace_emissions_from_in_region</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">save_local_source_contributions_from_in_region</span><span class="p">))</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">                </span><span class="n">filename_append</span><span class="o">=</span><span class="s1">&#39;_from_in_region&#39;</span>
<span class="w">            </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">save_total_source_contributions</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">EMEP_additional_grid_interpolation_size</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">                </span><span class="n">filename_append</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
<span class="w">            </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">trace_emissions_from_in_region</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">save_total_source_contributions_from_in_region</span><span class="p">))</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">                </span><span class="n">filename_append</span><span class="o">=</span><span class="s1">&#39;_from_in_region&#39;</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">                </span><span class="c">! skip rounds 3-4</span>
<span class="w">                </span><span class="k">cycle</span>
<span class="k">            end if</span>

<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving downscaled contributions&#39;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving downscaled contributions from-in-region&#39;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving total contributions&#39;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving total contributions from-in-region&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_fraction_as_contribution_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">                </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;ug/m3&quot;</span>
<span class="w">            </span><span class="k">else</span>
<span class="k">                </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;byte&#39;</span>
<span class="w">                </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;%&quot;</span>
<span class="w">            </span><span class="k">endif</span>

<span class="k">            do </span><span class="n">i_pollutant</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_pollutant_loop</span>
<span class="w">                </span><span class="k">do </span><span class="n">i_source</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_source_index</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                        </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_sourcetotal_file_index</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                    </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                        </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_sourcetotal_inregion_file_index</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                    </span><span class="k">else</span><span class="w">  </span><span class="c">! 1 or 2</span>
<span class="w">                        </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_local_file_index</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                    </span><span class="k">end if</span>
<span class="w">                    </span><span class="c">!if (calculate_source(i_source).or.i_source.eq.allsource_index) then</span>
<span class="w">                    </span><span class="c">!Don&#39;t save any exhaust, sand or salt pollutant sources. Dealt with later</span>
<span class="w">                    </span><span class="c">!(calculate_source(i_source).or.calculate_emep_source(i_source))</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">calculate_source</span><span class="p">(</span><span class="n">i_source</span><span class="p">).</span><span class="nb">and</span><span class="p">.</span><span class="n">i_source</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="n">allsource_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pmex_index</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pm25_sand_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pm10_sand_index</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pm25_salt_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pm10_salt_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>

<span class="w">                        </span><span class="c">!Only save nonexhaust pm and all the other sources</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">nox_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">i_source</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">traffic_index</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="w">                            </span><span class="c">!if ((pollutant_loop_index(i_pollutant).ne.nox_index.or.i_source.ne.traffic_index)) then</span>
<span class="w">                        </span><span class="k">else</span>
<span class="k">                            if</span><span class="w"> </span><span class="p">(</span><span class="n">i_source</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">traffic_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.(</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">pm10_index</span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">pm25_index</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                </span><span class="c">! Special case for traffic pm: In some setups we need to subtract exhaust to get non-exhaust</span>
<span class="w">                                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pollutant_index</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">all_totals_nc_index</span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">pollutant_index</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">aaqd_totals_nc_index</span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">pollutant_index</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">gp_totals_nc_index</span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">pollutant_index</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">op_totals_nc_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                    </span><span class="c">! Traffic exhaust is not a separate pollutant, so just save total traffic</span>
<span class="w">                                    </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">),</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_append</span><span class="p">)</span>
<span class="w">                                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                                    </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid_local_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                                    </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">-</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">+</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_additional_local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                                    </span><span class="k">else</span><span class="w"> </span><span class="c">! source_domain_loop == 6</span>
<span class="w">                                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid_local_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">+</span><span class="n">subgrid_EMEP_semilocal_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                                    </span><span class="k">endif</span>
<span class="k">                                else</span>
<span class="w">                                    </span><span class="c">! Calculate non-exhaust as difference between total traffic and exhaust for downscaled contributions</span>
<span class="w">                                    </span><span class="c">! For EMEP contributions, non-exhaust can be directly accessed with traffic_nonexhaust_nc_index</span>
<span class="w">                                    </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">),</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_nonexhaust&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_append</span><span class="p">)</span>
<span class="w">                                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">-</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">pollutant_loop_back_index</span><span class="p">(</span><span class="n">pmex_index</span><span class="p">))</span>
<span class="w">                                    </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid_local_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">-</span><span class="n">subgrid_local_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">pollutant_loop_back_index</span><span class="p">(</span><span class="n">pmex_index</span><span class="p">))</span>
<span class="w">                                    </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">-</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">pollutant_loop_back_index</span><span class="p">(</span><span class="n">pmex_index</span><span class="p">))</span><span class="o">-</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_local_subgrid_index</span><span class="p">,</span><span class="n">traffic_nonexhaust_nc_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">+</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_additional_local_subgrid_index</span><span class="p">,</span><span class="n">traffic_nonexhaust_nc_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                                    </span><span class="k">else</span><span class="w">  </span><span class="c">!source_domain_loop == 6</span>
<span class="w">                                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid_local_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">-</span><span class="n">subgrid_local_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">pollutant_loop_back_index</span><span class="p">(</span><span class="n">pmex_index</span><span class="p">))</span><span class="o">+</span><span class="n">subgrid_EMEP_semilocal_from_in_region</span><span class="p">(:,:,:,</span><span class="n">traffic_nonexhaust_nc_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                                    </span><span class="k">end if</span>
<span class="k">                                endif</span>
<span class="k">                            else</span>
<span class="k">                                </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">),</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_append</span><span class="p">)</span>
<span class="w">                                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                                </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid_local_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                                </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">-</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">+</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_additional_local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                                </span><span class="k">else</span><span class="w"> </span><span class="c">! source_domain_loop == 6</span>
<span class="w">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid_local_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">+</span><span class="n">subgrid_EMEP_semilocal_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                                </span><span class="k">endif</span>
<span class="k">                            endif</span>
<span class="w">                            </span><span class="c">! Convert to fractions</span>
<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">save_netcdf_fraction_as_contribution_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">temp_subgrid</span><span class="o">/</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">total_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="mf">0.</span>
<span class="w">                            </span><span class="k">end if</span>
<span class="w">                            </span><span class="c">!In case of any 0 concentrations when using the fractional contributions</span>
<span class="w">                            </span><span class="k">where</span><span class="w"> </span><span class="p">(</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">total_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mi">0</span>

<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                </span><span class="c">!write(unit_logfile,&#39;(a,f12.3)&#39;)&#39;Writing netcdf variable: &#39;//trim(var_name_temp),sum(temp_subgrid)/size(temp_subgrid,1)/size(temp_subgrid,2)/size(temp_subgrid,3)</span>
<span class="w">                                </span><span class="c">!write(unit_logfile,&#39;(a,f12.3)&#39;)&#39;Writing netcdf variable: &#39;//trim(var_name_temp), mean_nodata(temp_subgrid,size(temp_subgrid,1),size(temp_subgrid,2),size(temp_subgrid,3),NODATA_value)</span>
<span class="w">                                </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>


<span class="w">                                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                            </span><span class="k">endif</span>
<span class="k">                            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                                </span><span class="c">! write(unit_logfile,&#39;(a,f12.3)&#39;)&#39;Writing netcdf receptor variable: &#39;//trim(var_name_temp),sum(temp_subgrid)/size(temp_subgrid,1)/size(temp_subgrid,2)/size(temp_subgrid,3)</span>
<span class="w">                                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                            </span><span class="k">endif</span>

<span class="k">                        endif</span>

<span class="w">                        </span><span class="c">!Special case for exhaust as this must be given as a fraction for both PM2.5 and PM10.</span>
<span class="w">                        </span><span class="c">!if ((pollutant_loop_index(i_pollutant).eq.pm10_index.or.pollutant_loop_index(i_pollutant).eq.pm25_index).and.i_source.eq.traffic_index) then</span>
<span class="w">                        </span><span class="c">!Write all exhaust pollutants except the pmex</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_source</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">traffic_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.(.</span><span class="nb">not</span><span class="p">.</span><span class="n">pollutant_index</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">all_totals_nc_index</span><span class="p">.</span><span class="nb">and</span><span class="p">..</span><span class="nb">not</span><span class="p">.</span><span class="n">pollutant_index</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">aaqd_totals_nc_index</span><span class="p">.</span><span class="nb">and</span><span class="p">..</span><span class="nb">not</span><span class="p">.</span><span class="n">pollutant_index</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">gp_totals_nc_index</span><span class="p">.</span><span class="nb">and</span><span class="p">..</span><span class="nb">not</span><span class="p">.</span><span class="n">pollutant_index</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">op_totals_nc_index</span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">nox_index</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>

<span class="w">                            </span><span class="c">!If PM then exhaust output is exhaust</span>
<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">pm10_index</span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">pm25_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">pollutant_loop_back_index</span><span class="p">(</span><span class="n">pmex_index</span><span class="p">))</span>
<span class="w">                                </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid_local_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">pollutant_loop_back_index</span><span class="p">(</span><span class="n">pmex_index</span><span class="p">))</span>
<span class="w">                                </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">pollutant_loop_back_index</span><span class="p">(</span><span class="n">pmex_index</span><span class="p">))</span><span class="o">-</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_local_subgrid_index</span><span class="p">,</span><span class="n">traffic_exhaust_nc_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">+</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_additional_local_subgrid_index</span><span class="p">,</span><span class="n">traffic_exhaust_nc_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                                </span><span class="k">else</span><span class="w"> </span><span class="c">!source_domain_loop == 6</span>
<span class="w">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid_local_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">pollutant_loop_back_index</span><span class="p">(</span><span class="n">pmex_index</span><span class="p">))</span><span class="o">+</span><span class="n">subgrid_EMEP_semilocal_from_in_region</span><span class="p">(:,:,:,</span><span class="n">traffic_exhaust_nc_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                                </span><span class="k">end if</span>
<span class="k">                            else</span>
<span class="k">                                if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                                </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid_local_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                                </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">-</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">+</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_additional_local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                                </span><span class="k">else</span><span class="w"> </span><span class="c">!source_domain_loop == 6</span>
<span class="w">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid_local_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">+</span><span class="n">subgrid_EMEP_semilocal_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                                </span><span class="k">end if</span>
<span class="k">                            endif</span>
<span class="k">                            </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">),</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_exhaust&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_append</span><span class="p">)</span>
<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">save_netcdf_fraction_as_contribution_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">temp_subgrid</span><span class="o">/</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">total_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="mf">0.</span>
<span class="w">                            </span><span class="k">end if</span>
<span class="k">                            where</span><span class="w"> </span><span class="p">(</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">total_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mi">0</span>

<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                </span><span class="c">!write(unit_logfile,&#39;(a,f12.3)&#39;)&#39;Writing netcdf variable: &#39;//trim(var_name_temp),sum(temp_subgrid)/size(temp_subgrid,1)/size(temp_subgrid,2)/size(temp_subgrid,3)</span>
<span class="w">                                </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                            </span><span class="k">endif</span>
<span class="k">                            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                                </span><span class="c">!write(unit_logfile,&#39;(a,f12.3)&#39;)&#39;Writing netcdf receptor variable: &#39;//trim(var_name_temp),sum(temp_subgrid)/size(temp_subgrid,1)/size(temp_subgrid,2)/size(temp_subgrid,3)</span>
<span class="w">                                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                            </span><span class="k">endif</span>

<span class="k">                        endif</span>
<span class="k">                    endif</span>

<span class="w">                    </span><span class="c">!Special case for salt and sand</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">pm25_sand_index</span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">pm10_sand_index</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">pm25_salt_index</span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">pm10_salt_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                        </span><span class="c">!Save the nonexhaust sand and salt</span>
<span class="w">                        </span><span class="c">! NB: sand and salt do not have EMEP contributions, so total is the same as local</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_source</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">traffic_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                            </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">),</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_append</span><span class="p">)</span>
<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                            </span><span class="k">else</span><span class="w">  </span><span class="c">! 2 or 6</span>
<span class="w">                                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid_local_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                            </span><span class="k">end if</span>
<span class="k">                            if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">save_netcdf_fraction_as_contribution_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                </span><span class="c">!temp_subgrid=subgrid(:,:,:,local_subgrid_index,i_source,i_pollutant)</span>
<span class="w">                                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">pm10_sand_index</span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">pm10_salt_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">temp_subgrid</span><span class="o">/</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">total_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">pollutant_loop_back_index</span><span class="p">(</span><span class="n">pm10_index</span><span class="p">))</span><span class="o">*</span><span class="mi">10</span><span class="mf">0.</span>
<span class="w">                                </span><span class="k">else</span>
<span class="k">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">temp_subgrid</span><span class="o">/</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">total_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">pollutant_loop_back_index</span><span class="p">(</span><span class="n">pm25_index</span><span class="p">))</span><span class="o">*</span><span class="mi">10</span><span class="mf">0.</span>
<span class="w">                                </span><span class="k">endif</span>

<span class="k">                            endif</span>
<span class="k">                            where</span><span class="w"> </span><span class="p">(</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">total_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mi">0</span>

<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                            </span><span class="k">endif</span>
<span class="k">                            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                            </span><span class="k">endif</span>

<span class="k">                        endif</span>
<span class="k">                    endif</span>
<span class="k">                end do</span><span class="w">  </span><span class="c">! i_source</span>
<span class="w">            </span><span class="k">end do</span><span class="w">  </span><span class="c">! i_pollutant</span>
<span class="w">        </span><span class="k">end do</span><span class="w">  </span><span class="c">! source_domain_loop</span>

<span class="w">        </span><span class="c">! Save the total nonlocal contributions from EMEP (not saving it for in-region domains!)</span>
<span class="w">        </span><span class="c">! 1 = nonlocal to the moving window</span>
<span class="w">        </span><span class="c">! 2 = not used, but kept for consistency with other source_domain_loop loops</span>
<span class="w">        </span><span class="c">! 3 = nonlocal to the additional domain</span>
<span class="w">        </span><span class="k">do </span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;-------------------------------&#39;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Saving nonlocal contributions&#39;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Saving additional nonlocal contributions&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;-------------------------------&#39;</span>
<span class="w">            </span><span class="k">do </span><span class="n">i_pollutant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n_pollutant_loop</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pmex_index</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pm25_sand_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pm10_sand_index</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pm25_salt_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pm10_salt_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                        if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">save_source_contributions</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">save_emep_source_contributions</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">save_total_source_contributions</span><span class="p">))</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">                        </span><span class="n">i_file</span><span class="o">=</span><span class="n">emep_subgrid_nonlocal_file_index</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">)</span>
<span class="w">                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_nonlocal_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                    </span><span class="k">else</span><span class="w"> </span><span class="c">! source_domain_loop == 3</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">EMEP_additional_grid_interpolation_size</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">save_emep_additional_source_contributions</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">save_total_source_contributions</span><span class="p">)))</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">                        </span><span class="n">i_file</span><span class="o">=</span><span class="n">emep_additional_subgrid_nonlocal_file_index</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">)</span>
<span class="w">                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_additional_nonlocal_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                    </span><span class="k">end if</span>
<span class="k">                    </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">),</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_fraction_as_contribution_flag</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">temp_subgrid</span><span class="o">/</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">total_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="mf">0.</span>
<span class="w">                    </span><span class="k">end if</span>
<span class="k">                    where</span><span class="w"> </span><span class="p">(</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">total_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mi">0</span>

<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                        write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                        </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                    </span><span class="k">endif</span>
<span class="k">                    if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                        write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                        </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                    </span><span class="k">endif</span>
<span class="k">                end if</span>
<span class="k">            enddo</span><span class="w">  </span><span class="c">! i_pollutant</span>
<span class="w">        </span><span class="k">end do</span><span class="w">  </span><span class="c">! source_domain_loop</span>


<span class="w">        </span><span class="c">! Calculate and save NO2 and O3 source contributions</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_no2_source_contributions</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">save_o3_source_contributions</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>

<span class="w">            </span><span class="c">! Calculate NO2 and O3 source contributions</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EMEP_additional_grid_interpolation_size</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                </span><span class="n">calculate_EMEP_additional_grid_flag</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_source_fraction_chemistry</span>
<span class="w">            </span><span class="k">endif</span>

<span class="k">            </span><span class="n">calculate_EMEP_additional_grid_flag</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">            </span><span class="k">call </span><span class="n">uEMEP_source_fraction_chemistry</span>

<span class="w">            </span><span class="c">! Save the contributions to file</span>
<span class="w">            </span><span class="c">! 1 = normal source contributions from within moving window</span>
<span class="w">            </span><span class="c">! 2 = source contributions cut down to region</span>
<span class="w">            </span><span class="c">! 3 = additional nonlocal</span>
<span class="w">            </span><span class="c">! 4 = semilocal contribution from in region, based on background</span>
<span class="w">            </span><span class="c">! 5 = not used, but kept to be consistent with other loops over &quot;source_domain_loop&quot;</span>
<span class="w">            </span><span class="c">! 6 = total contribution from in region = 2+4</span>
<span class="w">            </span><span class="k">do </span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span>
<span class="w">                </span>
<span class="w">                </span><span class="c">! Skip this round in the loop if this type of source contributions are not to be saved</span>
<span class="w">                </span><span class="c">! or set appropriate variable name extension</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">save_source_contributions</span><span class="p">)</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">                    </span><span class="n">filename_append</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
<span class="w">                </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">trace_emissions_from_in_region</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">save_local_source_contributions_from_in_region</span><span class="p">))</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">                    </span><span class="n">filename_append</span><span class="o">=</span><span class="s1">&#39;_from_in_region&#39;</span>
<span class="w">                </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">EMEP_additional_grid_interpolation_size</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">save_emep_additional_source_contributions</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">save_total_source_contributions</span><span class="p">)))</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">                    </span><span class="n">filename_append</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
<span class="w">                </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">trace_emissions_from_in_region</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">save_semilocal_source_contributions_from_in_region</span><span class="p">))</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">                    </span><span class="n">filename_append</span><span class="o">=</span><span class="s1">&#39;_from_in_region&#39;</span>
<span class="w">                </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    cycle</span>
<span class="k">                else</span><span class="w">  </span><span class="c">! source_domain_loop == 6</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">trace_emissions_from_in_region</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">save_total_source_contributions_from_in_region</span><span class="p">))</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">                    </span><span class="n">filename_append</span><span class="o">=</span><span class="s1">&#39;_from_in_region&#39;</span>
<span class="w">                </span><span class="k">end if</span>

<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;-------------------------------&#39;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Saving local NO2 and O3 contributions&#39;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Saving local NO2 and O3 contributions from-in-region&#39;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Saving additional nonlocal NO2 and O3 contributions&#39;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Saving semilocal NO2 and O3 contributions from-in-region&#39;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Saving total NO2 and O3 contributions from-in-region&#39;</span>
<span class="w">                </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;-------------------------------&#39;</span>

<span class="w">                </span><span class="c">! Save NO2 in round 1 and O3 in round 2</span>
<span class="w">                </span><span class="k">do </span><span class="n">no2_o3_loop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span>

<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">no2_o3_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">  </span><span class="c">! no2</span>
<span class="w">                        </span><span class="n">comp_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">no2_index</span>
<span class="w">                        </span><span class="n">comp_nc_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">no2_nc_index</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">save_no2_source_contributions</span><span class="p">)</span><span class="w"> </span><span class="k">cycle</span>

<span class="k">                        </span><span class="n">valid_min</span><span class="o">=</span><span class="mf">0.</span>

<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_fraction_as_contribution_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">                            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;ug/m3&quot;</span>
<span class="w">                        </span><span class="k">else</span>
<span class="k">                            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;byte&#39;</span>
<span class="w">                            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;%&quot;</span>
<span class="w">                        </span><span class="k">endif</span>

<span class="k">                    else</span><span class="w">  </span><span class="c">! o3</span>
<span class="w">                        </span><span class="n">comp_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">o3_index</span>
<span class="w">                        </span><span class="n">comp_nc_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">o3_nc_index</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">save_o3_source_contributions</span><span class="p">)</span><span class="w"> </span><span class="k">cycle</span>

<span class="k">                        if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_fraction_as_contribution_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">                            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;ug/m3&quot;</span>
<span class="w">                            </span><span class="n">valid_min</span><span class="o">=-</span><span class="mi">100</span><span class="mf">0.</span>
<span class="w">                        </span><span class="k">else</span>
<span class="k">                            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;short&#39;</span>
<span class="w">                            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;%&quot;</span>
<span class="w">                            </span><span class="n">valid_min</span><span class="o">=-</span><span class="mi">10</span><span class="mf">0.</span>
<span class="w">                        </span><span class="k">endif</span>
<span class="k">                    end if</span>

<span class="k">                    do </span><span class="n">i_source</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_source_index</span>

<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_source</span><span class="w"> </span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="w"> </span><span class="n">allsource_index</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">calculate_source</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">calculate_emep_source</span><span class="p">(</span><span class="n">i_source</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="w">                            </span><span class="c">!Do not save nonexhaust for exhaust gas emissions</span>
<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_source</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">traffic_nonexhaust_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                cycle</span>
<span class="k">                            end if</span>

<span class="k">                            if</span><span class="w"> </span><span class="p">(</span><span class="n">i_source</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">allsource_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                </span><span class="c">! Non-local contributions</span>
<span class="w">                                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                    </span><span class="c">! nonlocal to the normal domain</span>
<span class="w">                                    </span><span class="n">i_file</span><span class="o">=</span><span class="n">emep_subgrid_nonlocal_file_index</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">comp_source_EMEP_subgrid</span><span class="p">(:,:,:,</span><span class="n">comp_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                                </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                    </span><span class="c">! nonlocal to the additional domain</span>
<span class="w">                                    </span><span class="n">i_file</span><span class="o">=</span><span class="n">emep_additional_subgrid_nonlocal_file_index</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">comp_source_EMEP_additional_subgrid</span><span class="p">(:,:,:,</span><span class="n">comp_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                                </span><span class="k">else</span>
<span class="w">                                    </span><span class="c">! do not save nonlocal for the in-region versions</span>
<span class="w">                                    </span><span class="k">cycle</span>
<span class="k">                                end if</span>
<span class="k">                            else</span>
<span class="w">                                </span><span class="c">! Sector source contributions</span>
<span class="w">                                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                    </span><span class="c">! normal local domain</span>
<span class="w">                                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">calculate_source</span><span class="p">(</span><span class="n">i_source</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                        </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_local_file_index</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                                    </span><span class="k">else</span><span class="w"> </span><span class="c">! calculate_emep_source(i_source)</span>
<span class="w">                                        </span><span class="n">i_file</span><span class="o">=</span><span class="n">emep_subgrid_local_file_index</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                                    </span><span class="k">endif</span>
<span class="k">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">comp_source_subgrid</span><span class="p">(:,:,:,</span><span class="n">comp_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                                </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                    </span><span class="c">! in-region contributions within the normal local domain</span>
<span class="w">                                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">calculate_source</span><span class="p">(</span><span class="n">i_source</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                        </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_local_file_index</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                                    </span><span class="k">else</span><span class="w"> </span><span class="c">! calculate_emep_source(i_source)</span>
<span class="w">                                        </span><span class="n">i_file</span><span class="o">=</span><span class="n">emep_subgrid_local_file_index</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                                    </span><span class="k">endif</span>
<span class="k">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">comp_source_subgrid_from_in_region</span><span class="p">(:,:,:,</span><span class="n">comp_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                                </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                    </span><span class="c">! additional domain: save only non-local for additional domain</span>
<span class="w">                                    </span><span class="k">cycle</span>
<span class="k">                                else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                    </span><span class="c">! semilocal inregion contributions</span>
<span class="w">                                    </span><span class="n">i_file</span><span class="o">=</span><span class="n">emep_subgrid_semilocal_file_index</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">comp_semilocal_source_subgrid_from_in_region</span><span class="p">(:,:,:,</span><span class="n">comp_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                                </span><span class="k">else</span><span class="w"> </span><span class="c">! source_domain_loop == 6</span>
<span class="w">                                    </span><span class="c">! sum of local inregion and semilocal inregion</span>
<span class="w">                                    </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_sourcetotal_inregion_file_index</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">comp_semilocal_source_subgrid_from_in_region</span><span class="p">(:,:,:,</span><span class="n">comp_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">)</span><span class="o">+</span><span class="n">comp_source_subgrid_from_in_region</span><span class="p">(:,:,:,</span><span class="n">comp_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                                </span><span class="k">end if</span>
<span class="k">                            end if</span>

<span class="w">                            </span><span class="c">! Variable name</span>
<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_source</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">traffic_index</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">comp_index</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">no2_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                </span><span class="c">! special case for no2 traffic: add exhaust to variable name</span>
<span class="w">                                </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">comp_nc_index</span><span class="p">,</span><span class="n">allsource_nc_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_exhaust&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_append</span><span class="p">)</span>
<span class="w">                            </span><span class="k">else</span>
<span class="k">                                </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">comp_nc_index</span><span class="p">,</span><span class="n">allsource_nc_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_append</span><span class="p">)</span>
<span class="w">                            </span><span class="k">endif</span>

<span class="k">                            if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">save_netcdf_fraction_as_contribution_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                </span><span class="c">! Transform to fraction</span>
<span class="w">                                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">comp_index</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">o3_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                    </span><span class="c">! For O3, only include nonlocal when saving as fractions, and normalize with EMEP concentration to always get 100%</span>
<span class="w">                                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_source</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">allsource_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">temp_subgrid</span><span class="o">/</span><span class="n">comp_EMEP_subgrid</span><span class="p">(:,:,:,</span><span class="n">comp_index</span><span class="p">)</span>
<span class="w">                                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">100</span><span class="mf">0.</span><span class="p">)</span>
<span class="w">                                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="o">-</span><span class="mi">10</span><span class="mf">0.</span><span class="p">)</span>
<span class="w">                                    </span><span class="k">else</span>
<span class="k">                                        cycle</span>
<span class="k">                                    end if</span>
<span class="k">                                else</span>
<span class="w">                                    </span><span class="c">! for NO2, normalize with EMEP concentration for additional, and with uEMEP concentration in all other cases</span>
<span class="w">                                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">temp_subgrid</span><span class="o">/</span><span class="n">comp_EMEP_subgrid</span><span class="p">(:,:,:,</span><span class="n">comp_index</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="mf">0.</span>
<span class="w">                                    </span><span class="k">else</span>
<span class="k">                                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">temp_subgrid</span><span class="o">/</span><span class="n">comp_subgrid</span><span class="p">(:,:,:,</span><span class="n">comp_index</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="mf">0.</span>
<span class="w">                                    </span><span class="k">end if</span>
<span class="k">                                end if</span>
<span class="k">                            endif</span>

<span class="w">                            </span><span class="c">! Save to file</span>
<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                            </span><span class="k">endif</span>
<span class="k">                            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                            </span><span class="k">endif</span>
<span class="k">                        endif</span>
<span class="k">                    enddo</span><span class="w"> </span><span class="c">!i_source</span>

<span class="w">                </span><span class="k">end do</span><span class="w"> </span><span class="c">!no2_o3_loop</span>

<span class="w">            </span><span class="k">end do</span><span class="w">  </span><span class="c">!source_domain_loop</span>

<span class="w">            </span><span class="n">valid_min</span><span class="o">=</span><span class="mf">0.</span>

<span class="w">        </span><span class="k">end if</span><span class="w"> </span><span class="c">!(save_no2_source_contributions .or. save_o3_source_contributions)</span>


<span class="w">        </span><span class="c">!Save the emissions interpolated to the target grid</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_emissions</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving emissions&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;g/s&quot;</span>
<span class="w">            </span><span class="k">do </span><span class="n">i_pollutant</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_pollutant_loop</span>
<span class="w">                </span><span class="k">do </span><span class="n">i_source</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_source_index</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">calculate_source</span><span class="p">(</span><span class="n">i_source</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>

<span class="w">                        </span><span class="c">!Do not save emissions if the source is not traffic and the pollutant is road sand and salt or exhaust as these do not exist</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_source</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="n">traffic_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.(</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">pm25_sand_index</span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">pm10_sand_index</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">pm25_salt_index</span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">pm10_salt_index</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">pmex_index</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="w">                            </span><span class="c">!Do nothing because these pollutants only exist for traffic</span>
<span class="w">                        </span><span class="k">else</span>

<span class="k">                            </span><span class="n">i_file</span><span class="o">=</span><span class="n">emission_file_index</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                            </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">),</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>

<span class="w">                            </span><span class="c">!Calculate the emissions in the target grid</span>
<span class="w">                            </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">                            </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                                </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>


<span class="w">                                    </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_emission_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                                    </span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_emission_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">)</span>

<span class="w">                                    </span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">emission_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                                    </span><span class="c">!Subgrid emissions, if relevant, are in units ug/sec/subgrid. Convert to g/s. Acount for the difference in subgrid sizes here</span>
<span class="w">                                    </span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="o">*</span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">*</span><span class="p">(</span><span class="n">subgrid_delta</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span><span class="o">*</span><span class="n">subgrid_delta</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                        </span><span class="o">/</span><span class="p">(</span><span class="n">emission_subgrid_delta</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">)</span><span class="o">*</span><span class="n">emission_subgrid_delta</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">))</span>

<span class="w">                                </span><span class="k">enddo</span>
<span class="k">                            enddo</span>

<span class="k">                            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                            </span><span class="k">endif</span>
<span class="k">                            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                            </span><span class="k">endif</span>

<span class="k">                        endif</span>

<span class="k">                    endif</span>
<span class="k">                enddo</span>
<span class="k">            enddo</span>
<span class="k">        endif</span>

<span class="w">        </span><span class="c">!Save population interpolated to the target grid</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_population</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;-------------------------------&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Saving population data&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;-------------------------------&#39;</span>
<span class="w">            </span>
<span class="w">            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;inhabitants/grid&quot;</span>

<span class="w">            </span><span class="n">i_file</span><span class="o">=</span><span class="n">population_file_index</span><span class="p">(</span><span class="n">population_index</span><span class="p">)</span>
<span class="w">            </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>

<span class="w">            </span><span class="c">!Calculate the population in the target grid</span>
<span class="w">            </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">            </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>

<span class="w">                    </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_population_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_population_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">)</span>

<span class="w">                    </span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">population_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">population_index</span><span class="p">)</span>
<span class="w">                    </span><span class="c">!Acount for the difference in subgrid sizes here</span>
<span class="w">                    </span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">*</span><span class="p">(</span><span class="n">subgrid_delta</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span><span class="o">*</span><span class="n">subgrid_delta</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="o">/</span><span class="p">(</span><span class="n">population_subgrid_delta</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span><span class="o">*</span><span class="n">population_subgrid_delta</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">))</span>

<span class="w">                </span><span class="k">enddo</span>
<span class="k">            enddo</span>

<span class="k">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s1">&#39;inhabitants/grid&#39;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>

<span class="k">        endif</span>

<span class="w">        </span><span class="c">! Save region mask at target subgrid</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">trace_emissions_from_in_region</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">  </span><span class="c">!! .or. use_region_select_and_mask_flag ??</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;-------------------------------&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Saving region mask&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;-------------------------------&#39;</span>

<span class="w">            </span><span class="n">variable_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;short&#39;</span>
<span class="w">            </span><span class="n">var_name_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;region_index&#39;</span>
<span class="w">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="w">  </span><span class="c">!!!!!!! what to write here???</span>
<span class="w">            </span><span class="n">temp_subgrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">            </span><span class="k">do </span><span class="n">tt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span>
<span class="w">                </span><span class="c">! add 0.1 to all values to avoid them being rounded down to 1 less than original value</span>
<span class="w">                </span><span class="n">temp_subgrid</span><span class="p">(:,:,</span><span class="n">tt</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subgrid_region_index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.1</span>
<span class="w">            </span><span class="k">end do</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">)</span>
<span class="w">                </span><span class="c">! NB: hard-coding scale_factor=1 since it does not make sense to have scale_factor for an ID variable!</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="mf">1.</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span><span class="c">! check if region is the same for the whole grid. If not, set to zero to avoid getting wrong ID when interpolating</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="nb">minval</span><span class="p">(</span><span class="n">subgrid_region_index</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">maxval</span><span class="p">(</span><span class="n">subgrid_region_index</span><span class="p">)))</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Warning: Not the same region_index for the whole receptor grid. Setting to 0.&#39;</span>
<span class="w">                    </span><span class="n">temp_subgrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">                </span><span class="k">end if</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="mf">1.</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">        end if</span>

<span class="w">        </span><span class="c">! Save EMEP allsources</span>
<span class="w">        </span><span class="c">! NB: For now, this is always saved</span>
<span class="w">        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving EMEP allsources&#39;</span>
<span class="w">        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">        </span><span class="k">do </span><span class="n">i_pollutant</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_emep_pollutant_loop</span>
<span class="w">            </span><span class="c">!EMEP does not have all pollutants so only save to n_emep_pollutant_loop</span>
<span class="w">            </span><span class="c">!Only save the allsource value here &#39;EMEP_allsources&#39;</span>
<span class="w">            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">            </span><span class="n">i_file</span><span class="o">=</span><span class="n">emep_subgrid_file_index</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">)</span>
<span class="w">            </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">),</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s1">&#39;ug/m3&#39;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">))</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">))</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">        end do</span>

<span class="w">        </span><span class="c">!Save the EMEP data interpolated to the subgrid. These are based on the gridded concentrations</span>
<span class="w">        </span><span class="c">! Loop over 5 different verions</span>
<span class="w">        </span><span class="c">! 1 = emep local contributions from the moving-window (downscaling domain)</span>
<span class="w">        </span><span class="c">! 2 = As 1, but only the part of the moving window that is within the receptor region</span>
<span class="w">        </span><span class="c">! 3 = emep additional local contributions, extending further using larger LF grid</span>
<span class="w">        </span><span class="c">! 4 = Semilocal contribution, i.e. outside moving-window but inside the receptor region</span>
<span class="w">        </span><span class="c">! 5 = total contribution: Same as 3 (but saved as a different name and under different flag)</span>
<span class="w">        </span><span class="c">! 6 = total contribution from_in_region = 2+4, only for sources not downscaled</span>
<span class="w">        </span><span class="k">do </span><span class="n">source_domain_loop</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span>

<span class="w">            </span><span class="c">! check if this version of source contributions should be saved</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">save_emep_source_contributions</span><span class="p">)</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">                </span><span class="n">filename_append</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<span class="w">            </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">save_local_source_contributions_from_in_region</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">trace_emissions_from_in_region</span><span class="p">))</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">                </span><span class="n">filename_append</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;_from_in_region&#39;</span>
<span class="w">            </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">save_emep_additional_source_contributions</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">EMEP_additional_grid_interpolation_size</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">                </span><span class="n">filename_append</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<span class="w">            </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">save_semilocal_source_contributions_from_in_region</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">trace_emissions_from_in_region</span><span class="p">))</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">                </span><span class="n">filename_append</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;_from_in_region&#39;</span>
<span class="w">            </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">save_total_source_contributions</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">EMEP_additional_grid_interpolation_size</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">                </span><span class="n">filename_append</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="c">!source_domain_loop == 6</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">save_total_source_contributions_from_in_region</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">trace_emissions_from_in_region</span><span class="p">))</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">                </span><span class="n">filename_append</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;_from_in_region&#39;</span>
<span class="w">            </span><span class="k">end if</span>

<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving EMEP contributions&#39;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving EMEP contributions from in region&#39;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving EMEP additional contributions&#39;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving EMEP semilocal contributions from in region&#39;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving total contributions&#39;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving total contributions from in region&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_fraction_as_contribution_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">                </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;ug/m3&quot;</span>
<span class="w">            </span><span class="k">else</span>
<span class="k">                </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;byte&#39;</span>
<span class="w">                </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;%&quot;</span>
<span class="w">            </span><span class="k">endif</span>

<span class="k">            do </span><span class="n">i_pollutant</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_emep_pollutant_loop</span>
<span class="w">                </span><span class="c">!EMEP does not have all pollutants so only save to n_emep_pollutant_loop</span>
<span class="w">                </span><span class="k">do </span><span class="n">i_source</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_source_index</span>
<span class="w">                    </span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">calculate_source</span><span class="p">(</span><span class="n">i_source</span><span class="p">).</span><span class="nb">or</span><span class="p">.</span><span class="n">save_EMEP_source</span><span class="p">(</span><span class="n">i_source</span><span class="p">).</span><span class="nb">or</span><span class="p">.</span><span class="n">i_source</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">allsource_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>

<span class="w">                        </span><span class="c">!Do not save for the additional GNFR sources</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_source</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">traffic_gasoline_nc_index</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">i_source</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">traffic_diesel_nc_index</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">i_source</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">traffic_gas_nc_index</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">i_source</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">publicpower_point_nc_index</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">i_source</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">publicpower_area_nc_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                            cycle</span>
<span class="k">                        end if</span>

<span class="w">                        </span><span class="c">!Do not save nonexhaust for exhaust gas emissions</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_source</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">traffic_nonexhaust_nc_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.(</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">no2_index</span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">nox_index</span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">o3_index</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">                            cycle</span>
<span class="k">                        end if</span>

<span class="k">                        if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                            </span><span class="c">! local EMEP contribution</span>
<span class="w">                            </span><span class="n">i_file</span><span class="o">=</span><span class="n">emep_subgrid_local_file_index</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                            </span><span class="n">temp_subgrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                        </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                            </span><span class="c">! local EMEP contribution cut down to in-region</span>
<span class="w">                            </span><span class="n">i_file</span><span class="o">=</span><span class="n">emep_subgrid_local_file_index</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                            </span><span class="n">temp_subgrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subgrid_EMEP_local_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                        </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                            </span><span class="c">! additional local EMEP contribution</span>
<span class="w">                            </span><span class="n">i_file</span><span class="o">=</span><span class="n">emep_additional_subgrid_local_file_index</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                            </span><span class="n">temp_subgrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_additional_local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                        </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                            </span><span class="c">! semilocal EMEP contribution</span>
<span class="w">                            </span><span class="n">i_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">emep_subgrid_semilocal_file_index</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                            </span><span class="n">temp_subgrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subgrid_EMEP_semilocal_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                        </span><span class="k">else</span><span class="w">   </span><span class="c">! source_domain_loop is 5 or 6</span>
<span class="w">                            </span><span class="c">! Only save total for non-downscaled sources, since downscaled sources were saved earlier</span>
<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_source</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">allsource_index</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">calculate_source</span><span class="p">(</span><span class="n">i_source</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                cycle</span>
<span class="k">                            else if</span><span class="w"> </span><span class="p">((</span><span class="n">i_source</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">traffic_exhaust_nc_index</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">i_source</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">traffic_nonexhaust_nc_index</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">calculate_source</span><span class="p">(</span><span class="n">traffic_index</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                </span><span class="c">! if traffic is downscaled, then total contributions to traffic exhaust and nonexhaust are saved earlier in the subroutine using downscaled local contributions</span>
<span class="w">                                </span><span class="k">cycle</span>
<span class="k">                            end if</span>
<span class="k">                            if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                </span><span class="c">! EMEP contribution from additional domain</span>
<span class="w">                                </span><span class="n">i_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subgrid_sourcetotal_file_index</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                                </span><span class="n">temp_subgrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_additional_local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                            </span><span class="k">else</span><span class="w"> </span><span class="c">!source_domain_loop == 6</span>
<span class="w">                                </span><span class="c">! sum of EMEP local and EMEP semilocal contribution</span>
<span class="w">                                </span><span class="n">i_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subgrid_sourcetotal_inregion_file_index</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                                </span><span class="n">temp_subgrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subgrid_EMEP_local_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">subgrid_EMEP_semilocal_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                            </span><span class="k">end if</span>
<span class="k">                        end if</span>

<span class="k">                        </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">),</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_append</span><span class="p">)</span>
<span class="w">                        </span><span class="c">!if (i_source.eq.traffic_exhaust_nc_index) var_name_temp=var_name_temp//&#39;_exhaust&#39;</span>
<span class="w">                        </span><span class="c">!if (i_source.eq.traffic_nonexhaust_nc_index) var_name_temp=var_name_temp//&#39;_nonexhaust&#39;</span>
<span class="w">                        </span><span class="c">! Transform to fraction</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">save_netcdf_fraction_as_contribution_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                            </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">temp_subgrid</span><span class="o">/</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="mf">0.</span>
<span class="w">                            </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">100</span><span class="mf">0.</span><span class="p">)</span>
<span class="w">                            </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="o">-</span><span class="mi">100</span><span class="mf">0.</span><span class="p">)</span>
<span class="w">                        </span><span class="k">endif</span>
<span class="k">                        if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                            </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                        </span><span class="k">endif</span>
<span class="k">                        if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                            </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                        </span><span class="k">endif</span>

<span class="k">                    endif</span>
<span class="k">                enddo</span><span class="w"> </span><span class="c">! i_source</span>
<span class="w">            </span><span class="k">enddo</span><span class="w"> </span><span class="c">! i_pollutant</span>

<span class="w">        </span><span class="k">enddo</span><span class="w"> </span><span class="c">!source_domain_loop</span>

<span class="w">        </span><span class="c">!Save the other interpolated EMEP compounds used for nox chemistry as well. These are based on the surface comp values</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_for_chemistry</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving for offline chemistry&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">            </span><span class="k">do </span><span class="n">i_pollutant</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_emep_pollutant_loop</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">nox_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    do </span><span class="n">i_loop</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_pollutant_compound_loop</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">)</span>

<span class="w">                        </span><span class="n">i_comp</span><span class="o">=</span><span class="n">pollutant_compound_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">,</span><span class="n">i_loop</span><span class="p">)</span>

<span class="w">                        </span><span class="c">!Somo35 may be included here. Do not include it if it is.</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_comp</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="n">somo35_nc_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>

<span class="k">                            </span><span class="n">i_file</span><span class="o">=</span><span class="n">emep_subgrid_file_index</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">)</span>
<span class="w">                            </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">i_comp</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_forchemistry&#39;</span><span class="o">//</span><span class="s1">&#39;_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">                            </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">comp_EMEP_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">)</span>
<span class="w">                            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;ug/m3&quot;</span>
<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                            </span><span class="k">endif</span>
<span class="k">                            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">comp_EMEP_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">))</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                            </span><span class="k">endif</span>

<span class="k">                        endif</span>
<span class="k">                    enddo</span>
<span class="k">                endif</span>
<span class="k">            enddo</span>
<span class="k">        endif</span>

<span class="w">        </span><span class="c">!Save weighted travel time</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_for_chemistry</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving weighted travel time&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">            </span><span class="n">var_name_temp</span><span class="o">=</span><span class="s1">&#39;Weighted_travel_time&#39;</span>
<span class="w">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s1">&#39;seconds&#39;</span>
<span class="w">            </span><span class="n">i_pollutant</span><span class="o">=</span><span class="n">pollutant_loop_back_index</span><span class="p">(</span><span class="n">nox_nc_index</span><span class="p">)</span><span class="w"> </span><span class="c">!Only save the travel time for nox. Though this may be expanded for other compounds if necessary, like ammonia</span>
<span class="w">            </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">traveltime_subgrid</span><span class="p">(:,:,:,</span><span class="mi">3</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="c">!write(unit_logfile,&#39;(a)&#39;)&#39;Writing netcdf variable: &#39;//trim(var_name_temp)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="c">!write(unit_logfile,&#39;(a,f12.3)&#39;)&#39;Writing netcdf receptor variable: &#39;//trim(var_name_temp),sum(traveltime_subgrid(:,:,:,1,i_pollutant))/size(subgrid,1)/size(subgrid,2)/size(subgrid,3)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">        endif</span>

<span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="n">save_for_chemistry</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">            </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_J_file_index</span>
<span class="w">            </span><span class="n">i_meteo</span><span class="o">=</span><span class="n">J_subgrid_index</span>
<span class="w">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;1/s&quot;</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>
<span class="w">            </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">            </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">            </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">);</span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">meteo_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:,</span><span class="n">i_meteo</span><span class="p">)</span>
<span class="w">                </span><span class="k">enddo</span>
<span class="k">            enddo</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="c">!write(unit_logfile,&#39;(a)&#39;)&#39;Writing netcdf variable: &#39;//trim(var_name_temp)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="c">!write(unit_logfile,&#39;(a,f12.3)&#39;)&#39;Writing netcdf receptor variable: &#39;//trim(var_name_temp),sum(temp_subgrid)/size(temp_subgrid,1)/size(temp_subgrid,2)/size(temp_subgrid,3)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>

<span class="w">            </span><span class="c">!Save temperature if not also saving the meteo data.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="n">save_other_meteo</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">                </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_t2m_file_index</span>
<span class="w">                </span><span class="n">i_meteo</span><span class="o">=</span><span class="n">t2m_subgrid_index</span>
<span class="w">                </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;Celcius&quot;</span>
<span class="w">                </span><span class="c">!The same for all--------------------</span>
<span class="w">                </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">                </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                        </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">);</span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">meteo_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:,</span><span class="n">i_meteo</span><span class="p">)</span><span class="o">-</span><span class="mi">27</span><span class="mf">3.13</span>
<span class="w">                    </span><span class="k">enddo</span>
<span class="k">                enddo</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="c">!write(unit_logfile,&#39;(a)&#39;)&#39;Writing netcdf variable: &#39;//trim(var_name_temp)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="c">!write(unit_logfile,&#39;(a,f12.3)&#39;)&#39;Writing netcdf receptor variable: &#39;//trim(var_name_temp),sum(temp_subgrid)/size(temp_subgrid,1)/size(temp_subgrid,2)/size(temp_subgrid,3)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="k">            endif</span>
<span class="k">        endif</span>

<span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="n">save_emep_species</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving EMEP species&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">            </span><span class="k">do </span><span class="n">i_sp</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_species_loop_index</span>
<span class="w">                </span><span class="n">ii_sp</span><span class="o">=</span><span class="n">species_loop_index</span><span class="p">(</span><span class="n">i_sp</span><span class="p">)</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_sp</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="n">sp_pm_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                    </span><span class="c">!Do not include the total</span>
<span class="w">                    </span><span class="k">do </span><span class="n">i_loop</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_pmxx_sp_index</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">pm25_sp_index</span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">i_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">pm10_sp_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>

<span class="k">                            if</span><span class="w"> </span><span class="p">(</span><span class="n">i_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">pm25_sp_index</span><span class="p">)</span><span class="w"> </span><span class="n">i_pollutant</span><span class="o">=</span><span class="n">pollutant_loop_back_index</span><span class="p">(</span><span class="n">pm25_index</span><span class="p">)</span>
<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">pm10_sp_index</span><span class="p">)</span><span class="w"> </span><span class="n">i_pollutant</span><span class="o">=</span><span class="n">pollutant_loop_back_index</span><span class="p">(</span><span class="n">pm10_index</span><span class="p">)</span>

<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_fraction_as_contribution_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">                                </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">species_name_nc</span><span class="p">(</span><span class="n">i_loop</span><span class="p">,</span><span class="n">ii_sp</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_nonlocal_contribution&#39;</span>
<span class="w">                                </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;ug/m3&quot;</span>
<span class="w">                                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">species_EMEP_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_loop</span><span class="p">,</span><span class="n">i_sp</span><span class="p">)</span>
<span class="w">                            </span><span class="k">else</span>
<span class="k">                                </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;byte&#39;</span>
<span class="w">                                </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">species_name_nc</span><span class="p">(</span><span class="n">i_loop</span><span class="p">,</span><span class="n">i_sp</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_nonlocal_fraction&#39;</span>
<span class="w">                                </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;%&quot;</span>
<span class="w">                                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">species_EMEP_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_loop</span><span class="p">,</span><span class="n">i_sp</span><span class="p">)</span><span class="o">/</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">total_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="mf">0.</span>
<span class="w">                            </span><span class="k">endif</span>

<span class="k">                            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">(:,:,:))</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                            </span><span class="k">endif</span>
<span class="k">                            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">(:,:,:))</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                            </span><span class="k">endif</span>
<span class="k">                        endif</span>
<span class="k">                    enddo</span>
<span class="k">                endif</span>
<span class="k">            enddo</span>
<span class="k">        endif</span>

<span class="w">        </span><span class="c">!Only save sea salt in this way when emep species are not saved in the general way</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_seasalt</span><span class="p">.</span><span class="nb">and</span><span class="p">..</span><span class="nb">not</span><span class="p">.</span><span class="n">save_emep_species</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving EMEP sea salt&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">            </span><span class="n">i_sp</span><span class="o">=</span><span class="n">n_species_loop_index</span>
<span class="w">            </span><span class="n">ii_sp</span><span class="o">=</span><span class="n">species_loop_index</span><span class="p">(</span><span class="n">i_sp</span><span class="p">)</span>
<span class="w">            </span><span class="k">do </span><span class="n">i_loop</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_pmxx_sp_index</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">pm25_sp_index</span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">i_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">pm10_sp_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>

<span class="k">                    if</span><span class="w"> </span><span class="p">(</span><span class="n">i_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">pm25_sp_index</span><span class="p">)</span><span class="w"> </span><span class="n">i_pollutant</span><span class="o">=</span><span class="n">pollutant_loop_back_index</span><span class="p">(</span><span class="n">pm25_index</span><span class="p">)</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">pm10_sp_index</span><span class="p">)</span><span class="w"> </span><span class="n">i_pollutant</span><span class="o">=</span><span class="n">pollutant_loop_back_index</span><span class="p">(</span><span class="n">pm10_index</span><span class="p">)</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_fraction_as_contribution_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                        </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">                        </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">species_name_nc</span><span class="p">(</span><span class="n">i_loop</span><span class="p">,</span><span class="n">ii_sp</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_nonlocal_contribution&#39;</span>
<span class="w">                        </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;ug/m3&quot;</span>
<span class="w">                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">species_EMEP_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_loop</span><span class="p">,</span><span class="n">i_sp</span><span class="p">)</span>
<span class="w">                    </span><span class="k">else</span>
<span class="k">                        </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;byte&#39;</span>
<span class="w">                        </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">species_name_nc</span><span class="p">(</span><span class="n">i_loop</span><span class="p">,</span><span class="n">ii_sp</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_nonlocal_fraction&#39;</span>
<span class="w">                        </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;%&quot;</span>
<span class="w">                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">species_EMEP_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_loop</span><span class="p">,</span><span class="n">i_sp</span><span class="p">)</span><span class="o">/</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">total_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="mf">0.</span>
<span class="w">                    </span><span class="k">endif</span>

<span class="k">                    if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                        write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">(:,:,:))</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                        </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                    </span><span class="k">endif</span>
<span class="k">                    if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                        write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">(:,:,:))</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                        </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                    </span><span class="k">endif</span>
<span class="k">                endif</span>
<span class="k">            enddo</span>

<span class="k">        endif</span>

<span class="w">        </span><span class="c">!Save the original EMEP compounds</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_emep_original</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving original EMEP&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">            </span><span class="k">do </span><span class="n">i_pollutant</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_emep_pollutant_loop</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pmex_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    do </span><span class="n">i_loop</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_pollutant_compound_loop</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">)</span>

<span class="w">                        </span><span class="n">i_comp</span><span class="o">=</span><span class="n">pollutant_compound_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">,</span><span class="n">i_loop</span><span class="p">)</span>

<span class="w">                        </span><span class="n">i_file</span><span class="o">=</span><span class="n">emep_subgrid_file_index</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">)</span>
<span class="w">                        </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">i_comp</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_original_EMEP_concentration&#39;</span>
<span class="w">                        </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;ug/m3&quot;</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_comp</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">somo35_index</span><span class="p">)</span><span class="w"> </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;ppbd&quot;</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                            </span><span class="c">!write(unit_logfile,&#39;(a,f12.3)&#39;)&#39;Writing netcdf variable: &#39;//trim(var_name_temp),sum(orig_EMEP_subgrid(:,:,:,i_comp))/size(subgrid,1)/size(subgrid,2)/size(subgrid,3)</span>
<span class="w">                            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">orig_EMEP_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">),</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                            </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">orig_EMEP_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                        </span><span class="k">endif</span>
<span class="k">                        if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                            </span><span class="c">! write(unit_logfile,&#39;(a,f12.3)&#39;)&#39;Writing netcdf receptor variable: &#39;//trim(var_name_temp),sum(orig_EMEP_subgrid(:,:,:,i_comp))/size(subgrid,1)/size(subgrid,2)/size(subgrid,3)</span>
<span class="w">                            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">orig_EMEP_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">),</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                            </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">orig_EMEP_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                        </span><span class="k">endif</span>
<span class="k">                    enddo</span>
<span class="k">                endif</span>
<span class="k">            enddo</span>
<span class="k">        endif</span>

<span class="w">        </span><span class="c">!Save AQI</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_aqi</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving AQI&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;byte&#39;</span>
<span class="w">            </span><span class="n">scale_factor</span><span class="o">=</span><span class="mf">0.1</span>
<span class="w">            </span><span class="c">!Hard coded AQI limits</span>
<span class="w">            </span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">no2_index</span><span class="p">;</span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">pm10_index</span><span class="p">;</span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">pm25_index</span><span class="p">;</span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="n">o3_index</span>
<span class="w">            </span><span class="n">aqi_limits_temp</span><span class="p">(:,</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="n">aqi_hourly_limits</span><span class="p">(:,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
<span class="w">            </span><span class="n">aqi_limits_temp</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">            </span><span class="n">aqi_limits_temp</span><span class="p">(:,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span><span class="mf">2.</span><span class="o">*</span><span class="n">aqi_hourly_limits</span><span class="p">(:,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">            </span><span class="n">aqi_subgrid</span><span class="o">=</span><span class="mf">0.</span>

<span class="w">            </span><span class="k">do </span><span class="n">t</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span>
<span class="w">                </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                        </span><span class="n">max_aqi</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">                        </span><span class="k">do </span><span class="n">l</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_save_aqi_pollutant_index</span><span class="w"> </span><span class="c">!pollutant (no2,pm10,pm2.5,o3)</span>
<span class="w">                            </span><span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="w"> </span><span class="c">!level</span>
<span class="w">                                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">comp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="n">l</span><span class="p">)).</span><span class="n">ge</span><span class="p">.</span><span class="n">aqi_limits_temp</span><span class="p">(</span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="n">l</span><span class="p">),</span><span class="n">k</span><span class="p">).</span><span class="nb">and</span><span class="p">.</span><span class="n">comp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="n">l</span><span class="p">)).</span><span class="n">lt</span><span class="p">.</span><span class="n">aqi_limits_temp</span><span class="p">(</span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="n">l</span><span class="p">),</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                    </span><span class="n">aqi_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="n">l</span><span class="p">))</span><span class="o">=</span><span class="n">k</span><span class="o">+</span><span class="p">(</span><span class="n">comp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="n">l</span><span class="p">))</span><span class="o">-</span><span class="n">aqi_limits_temp</span><span class="p">(</span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="n">l</span><span class="p">),</span><span class="n">k</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">aqi_limits_temp</span><span class="p">(</span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="n">l</span><span class="p">),</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">aqi_limits_temp</span><span class="p">(</span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="n">l</span><span class="p">),</span><span class="n">k</span><span class="p">))</span>
<span class="w">                                </span><span class="k">endif</span>
<span class="k">                            enddo</span>
<span class="k">                            </span><span class="n">aqi_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="n">l</span><span class="p">))</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">aqi_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="n">l</span><span class="p">)),</span><span class="mf">4.99</span><span class="p">)</span>
<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">aqi_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="n">l</span><span class="p">)).</span><span class="n">gt</span><span class="p">.</span><span class="n">max_aqi</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                </span><span class="n">max_aqi</span><span class="o">=</span><span class="n">aqi_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="n">l</span><span class="p">))</span>
<span class="w">                                </span><span class="n">aqi_responsible_pollutant_index</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">t</span><span class="p">)</span><span class="o">=</span><span class="n">l</span>
<span class="w">                            </span><span class="k">endif</span>
<span class="w">                            </span><span class="c">!write(*,*)  i,j,t,aqi_responsible_pollutant_index(i,j,t),aqi_subgrid(i,j,t,aqi_pollutant_index(l)),max_aqi</span>
<span class="w">                        </span><span class="k">enddo</span>
<span class="k">                    enddo</span>
<span class="k">                enddo</span>
<span class="k">            enddo</span>

<span class="k">            do </span><span class="n">l</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_save_aqi_pollutant_index</span>
<span class="w">                </span><span class="c">!write(unit_logfile,*)  &#39;MAX AQI in time and space from &#39;//trim(pollutant_file_str(aqi_pollutant_index(l)))//&#39; = &#39;,maxval(aqi_subgrid(:,:,:,aqi_pollutant_index(l)))</span>
<span class="w">            </span><span class="k">enddo</span>

<span class="k">            </span><span class="n">var_name_temp</span><span class="o">=</span><span class="s1">&#39;AQI&#39;</span>
<span class="w">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s1">&#39;1&#39;</span>
<span class="w">            </span><span class="c">!Take the maximum of the pollutants</span>
<span class="w">            </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="nb">maxval</span><span class="p">(</span><span class="n">aqi_subgrid</span><span class="p">(:,:,:,</span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_save_aqi_pollutant_index</span><span class="p">)),</span><span class="mi">4</span><span class="p">)</span><span class="o">/</span><span class="n">scale_factor</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="o">*</span><span class="n">scale_factor</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>


<span class="k">            do </span><span class="n">l</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_save_aqi_pollutant_index</span>

<span class="w">                </span><span class="n">i_comp</span><span class="o">=</span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
<span class="w">                </span><span class="n">var_name_temp</span><span class="o">=</span><span class="s1">&#39;AQI_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">i_comp</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">))</span>
<span class="w">                </span><span class="n">unit_str</span><span class="o">=</span><span class="s1">&#39;1&#39;</span>
<span class="w">                </span><span class="c">!Take the maximum of the pollutants</span>
<span class="w">                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">aqi_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">)</span><span class="o">/</span><span class="n">scale_factor</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="o">*</span><span class="n">scale_factor</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>

<span class="k">            enddo</span>

<span class="w">            </span><span class="c">!Reset scale_factor</span>
<span class="w">            </span><span class="n">scale_factor</span><span class="o">=</span><span class="mf">1.</span>

<span class="w">        </span><span class="k">endif</span>

<span class="w">        </span><span class="c">!Save deposition</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_deposition</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">calculate_deposition_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving deposition&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">            </span><span class="k">do </span><span class="n">i_pollutant</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_pollutant_loop</span>
<span class="w">                </span><span class="k">do </span><span class="n">i_source</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_source_index</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">calculate_source</span><span class="p">(</span><span class="n">i_source</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>

<span class="k">                        </span><span class="n">i_comp</span><span class="o">=</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">)</span>

<span class="w">                        </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">i_comp</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_local_dry_deposition_&#39;</span><span class="o">//</span><span class="n">source_file_str</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                        </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;mg/m2/hr&quot;</span>
<span class="w">                        </span><span class="c">!Save in mg per hour, conversition from ug/m2/s</span>
<span class="w">                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">drydepo_local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="mf">0.</span><span class="o">*</span><span class="mi">360</span><span class="mf">0.</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                            </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                        </span><span class="k">endif</span>
<span class="k">                        if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                            </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                        </span><span class="k">endif</span>

<span class="k">                        </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">i_comp</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_local_wet_deposition_&#39;</span><span class="o">//</span><span class="n">source_file_str</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                        </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;mg/m2/hr&quot;</span>
<span class="w">                        </span><span class="c">!Save in mg per hour, conversition from ug/m2/s</span>
<span class="w">                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">wetdepo_local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="mf">0.</span><span class="o">*</span><span class="mi">360</span><span class="mf">0.</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                            </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                        </span><span class="k">endif</span>
<span class="k">                        if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                            </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                        </span><span class="k">endif</span>

<span class="k">                    endif</span>
<span class="k">                enddo</span>

<span class="k">                </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">i_comp</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_nonlocal_dry_deposition_&#39;</span><span class="o">//</span><span class="n">source_file_str</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">)</span>
<span class="w">                </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;mg/m2/hr&quot;</span>
<span class="w">                </span><span class="c">!Save in mg per hour, conversition from ug/m2/s</span>
<span class="w">                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">drydepo_nonlocal_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="mf">0.</span><span class="o">*</span><span class="mi">360</span><span class="mf">0.</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>

<span class="k">                </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">i_comp</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_total_dry_deposition_&#39;</span><span class="o">//</span><span class="n">source_file_str</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">)</span>
<span class="w">                </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;mg/m2/hr&quot;</span>
<span class="w">                </span><span class="c">!Save in mg per hour, conversition from ug/m2/s</span>
<span class="w">                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="p">(</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">drydepo_nonlocal_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">+</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">drydepo_local_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">))</span><span class="o">/</span><span class="mi">100</span><span class="mf">0.</span><span class="o">*</span><span class="mi">360</span><span class="mf">0.</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>

<span class="k">                </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">i_comp</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_nonlocal_wet_deposition_&#39;</span><span class="o">//</span><span class="n">source_file_str</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">)</span>
<span class="w">                </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;mg/m2/hr&quot;</span>
<span class="w">                </span><span class="c">!Save in mg per hour, conversition from ug/m2/s</span>
<span class="w">                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">wetdepo_nonlocal_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="mf">0.</span><span class="o">*</span><span class="mi">360</span><span class="mf">0.</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>

<span class="k">                </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">i_comp</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_total_wet_deposition_&#39;</span><span class="o">//</span><span class="n">source_file_str</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">)</span>
<span class="w">                </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;mg/m2/hr&quot;</span>
<span class="w">                </span><span class="c">!Save in mg per hour, conversition from ug/m2/s</span>
<span class="w">                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="p">(</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">wetdepo_nonlocal_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">+</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">wetdepo_local_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">))</span><span class="o">/</span><span class="mi">100</span><span class="mf">0.</span><span class="o">*</span><span class="mi">360</span><span class="mf">0.</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>

<span class="w">                </span><span class="c">!Deposition velocity</span>
<span class="w">                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">                </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                        </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_deposition_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_deposition_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                        </span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">deposition_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:,</span><span class="n">vd_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                    </span><span class="k">enddo</span>
<span class="k">                enddo</span>
<span class="k">                </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">i_comp</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_deposition_velocity_&#39;</span><span class="o">//</span><span class="n">source_file_str</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">)</span>
<span class="w">                </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;cm/s&quot;</span>
<span class="w">                </span><span class="c">!Save in cm/s, conversition from ug/m2/s</span>
<span class="w">                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">temp_subgrid</span><span class="o">*</span><span class="mi">10</span><span class="mf">0.</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>

<span class="w">                </span><span class="c">!Landuse category</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">read_landuse_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">                    </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                        </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                            </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_deposition_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_deposition_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                            </span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">landuse_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">grid_index</span><span class="p">)</span>
<span class="w">                        </span><span class="k">enddo</span>
<span class="k">                    enddo</span>
<span class="k">                    </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">i_comp</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_EMEP_landuse_category&#39;</span>
<span class="w">                    </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;1&quot;</span>
<span class="w">                    </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;byte&#39;</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                        write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                        </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                    </span><span class="k">endif</span>
<span class="k">                    if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                        write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                        </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                    </span><span class="k">endif</span>
<span class="k">                endif</span>

<span class="k">                </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>

<span class="w">                </span><span class="c">!Save the original emep wet and dry deposition</span>
<span class="w">                </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">i_comp</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_original_EMEP_wet_deposition_&#39;</span><span class="o">//</span><span class="n">source_file_str</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">)</span>
<span class="w">                </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;mg/m2/hr&quot;</span>
<span class="w">                </span><span class="c">!Save in mg per hour, conversition from ug/m2/s</span>
<span class="w">                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">orig_emep_deposition_subgrid</span><span class="p">(:,:,:,</span><span class="n">wetdepo_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="k">                </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">i_comp</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_original_EMEP_dry_deposition_&#39;</span><span class="o">//</span><span class="n">source_file_str</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">)</span>
<span class="w">                </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;mg/m2/hr&quot;</span>
<span class="w">                </span><span class="c">!Save in mg per hour, conversition from ug/m2/s</span>
<span class="w">                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">orig_emep_deposition_subgrid</span><span class="p">(:,:,:,</span><span class="n">drydepo_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>

<span class="k">            enddo</span>

<span class="k">        endif</span>


<span class="w">        </span><span class="c">!Save the meteo interpolated to the target grid</span>
<span class="w">        </span><span class="n">valid_min</span><span class="o">=-</span><span class="mf">1.e24</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_wind_vectors</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving wind vectors&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">wind_vectors_10m_available</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_u10_file_index</span>
<span class="w">                </span><span class="n">i_meteo</span><span class="o">=</span><span class="n">u10_subgrid_index</span>
<span class="w">            </span><span class="k">else</span>
<span class="k">                </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_ugrid_file_index</span>
<span class="w">                </span><span class="n">i_meteo</span><span class="o">=</span><span class="n">ugrid_subgrid_index</span>
<span class="w">            </span><span class="k">endif</span>

<span class="k">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;m/s&quot;</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>
<span class="w">            </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">            </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">            </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">);</span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">meteo_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:,</span><span class="n">i_meteo</span><span class="p">)</span>
<span class="w">                </span><span class="k">enddo</span>
<span class="k">            enddo</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">wind_vectors_10m_available</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_v10_file_index</span>
<span class="w">                </span><span class="n">i_meteo</span><span class="o">=</span><span class="n">v10_subgrid_index</span>
<span class="w">            </span><span class="k">else</span>
<span class="k">                </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_vgrid_file_index</span>
<span class="w">                </span><span class="n">i_meteo</span><span class="o">=</span><span class="n">vgrid_subgrid_index</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;m/s&quot;</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>
<span class="w">            </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">            </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">            </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">);</span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">meteo_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:,</span><span class="n">i_meteo</span><span class="p">)</span>
<span class="w">                </span><span class="k">enddo</span>
<span class="k">            enddo</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>
<span class="w">        </span><span class="k">endif</span>


<span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="n">save_other_meteo</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving other meteo data&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">            </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_hmix_file_index</span>
<span class="w">            </span><span class="n">i_meteo</span><span class="o">=</span><span class="n">hmix_subgrid_index</span>
<span class="w">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;m&quot;</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>
<span class="w">            </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">            </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">            </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">);</span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">meteo_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:,</span><span class="n">i_meteo</span><span class="p">)</span>
<span class="w">                </span><span class="k">enddo</span>
<span class="k">            enddo</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>

<span class="w">            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">            </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_t2m_file_index</span>
<span class="w">            </span><span class="n">i_meteo</span><span class="o">=</span><span class="n">t2m_subgrid_index</span>
<span class="w">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;Celcius&quot;</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>
<span class="w">            </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">            </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">            </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">);</span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">meteo_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:,</span><span class="n">i_meteo</span><span class="p">)</span><span class="o">-</span><span class="mi">27</span><span class="mf">3.13</span>
<span class="w">                </span><span class="k">enddo</span>
<span class="k">            enddo</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>

<span class="w">            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">            </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_hmix_file_index</span>
<span class="w">            </span><span class="n">i_meteo</span><span class="o">=</span><span class="n">precip_subgrid_index</span>
<span class="w">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;mm/hr&quot;</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>
<span class="w">            </span><span class="n">var_name_temp</span><span class="o">=</span><span class="s1">&#39;precipitation&#39;</span><span class="c">!trim(filename_grid(i_file))</span>
<span class="w">            </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">            </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">);</span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">meteo_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:,</span><span class="n">i_meteo</span><span class="p">)</span>
<span class="w">                </span><span class="k">enddo</span>
<span class="k">            enddo</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>


<span class="w">            </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_kz_file_index</span>
<span class="w">            </span><span class="n">i_meteo</span><span class="o">=</span><span class="n">kz_subgrid_index</span>
<span class="w">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;m2/s&quot;</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>
<span class="w">            </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">            </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">            </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">);</span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">meteo_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:,</span><span class="n">i_meteo</span><span class="p">)</span>
<span class="w">                </span><span class="k">enddo</span>
<span class="k">            enddo</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hourly_calculations</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>

<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">wind_vectors_10m_available</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_FF10_file_index</span>
<span class="w">                    </span><span class="n">i_meteo</span><span class="o">=</span><span class="n">FF10_subgrid_index</span>
<span class="w">                </span><span class="k">else</span>
<span class="k">                    </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_FFgrid_file_index</span>
<span class="w">                    </span><span class="n">i_meteo</span><span class="o">=</span><span class="n">FFgrid_subgrid_index</span>
<span class="w">                </span><span class="k">endif</span>
<span class="k">                </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;m/s&quot;</span>
<span class="w">                </span><span class="c">!The same for all--------------------</span>
<span class="w">                </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">                </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                        </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">);</span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">meteo_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:,</span><span class="n">i_meteo</span><span class="p">)</span>
<span class="w">                    </span><span class="k">enddo</span>
<span class="k">                enddo</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="w">                </span><span class="c">!The same for all--------------------</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">wind_vectors_10m_available</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_DD10_file_index</span>
<span class="w">                </span><span class="k">else</span>
<span class="k">                    </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_DDgrid_file_index</span>
<span class="w">                </span><span class="k">endif</span>
<span class="w">                </span><span class="c">!i_meteo=DDgrid_subgrid_index !i_meteo not used in this conversion to wind direction</span>
<span class="w">                </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;degrees&quot;</span>
<span class="w">                </span><span class="k">do </span><span class="n">tt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="k">do </span><span class="n">jj</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">integral_subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                        </span><span class="k">do </span><span class="n">ii</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">integral_subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">wind_vectors_10m_available</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                </span><span class="n">temp_integral_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">tt</span><span class="p">)</span><span class="o">=</span><span class="n">DIRECTION</span><span class="p">(</span><span class="n">meteo_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">tt</span><span class="p">,</span><span class="n">u10_subgrid_index</span><span class="p">),</span><span class="n">meteo_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">tt</span><span class="p">,</span><span class="n">v10_subgrid_index</span><span class="p">))</span>
<span class="w">                            </span><span class="k">else</span>
<span class="k">                                </span><span class="n">temp_integral_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">tt</span><span class="p">)</span><span class="o">=</span><span class="n">DIRECTION</span><span class="p">(</span><span class="n">meteo_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">tt</span><span class="p">,</span><span class="n">ugrid_subgrid_index</span><span class="p">),</span><span class="n">meteo_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">tt</span><span class="p">,</span><span class="n">vgrid_subgrid_index</span><span class="p">))</span>
<span class="w">                            </span><span class="k">endif</span>

<span class="k">                        enddo</span>
<span class="k">                    enddo</span>
<span class="k">                enddo</span>
<span class="w">                </span><span class="c">!This is not converted to real degrees, but subgrid degrees, so is wrong but close</span>

<span class="w">                </span><span class="c">!The same for all--------------------</span>
<span class="w">                </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">                </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                        </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">);</span>
<span class="w">                        </span><span class="c">!In this case this is not the same for all</span>
<span class="w">                        </span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">temp_integral_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:)</span>
<span class="w">                    </span><span class="k">enddo</span>
<span class="k">                enddo</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="w">                </span><span class="c">!The same for all--------------------</span>

<span class="w">            </span><span class="k">endif</span>

<span class="k">            </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_invL_file_index</span>
<span class="w">            </span><span class="n">i_meteo</span><span class="o">=</span><span class="n">invL_subgrid_index</span>
<span class="w">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;1/m&quot;</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>
<span class="w">            </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">            </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">            </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">);</span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">meteo_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:,</span><span class="n">i_meteo</span><span class="p">)</span>
<span class="w">                </span><span class="k">enddo</span>
<span class="k">            enddo</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.4)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.4)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>

<span class="w">            </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_logz0_file_index</span>
<span class="w">            </span><span class="n">i_meteo</span><span class="o">=</span><span class="n">logz0_subgrid_index</span>
<span class="w">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;log(m)&quot;</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>
<span class="w">            </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">            </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">            </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">);</span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">meteo_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:,</span><span class="n">i_meteo</span><span class="p">)</span>
<span class="w">                </span><span class="k">enddo</span>
<span class="k">            enddo</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>

<span class="w">            </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_ustar_file_index</span>
<span class="w">            </span><span class="n">i_meteo</span><span class="o">=</span><span class="n">ustar_subgrid_index</span>
<span class="w">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;m/s&quot;</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>
<span class="w">            </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">            </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">            </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">);</span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">meteo_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:,</span><span class="n">i_meteo</span><span class="p">)</span>
<span class="w">                </span><span class="k">enddo</span>
<span class="k">            enddo</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">annual_calculations</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>

<span class="k">                </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_invFFgrid_file_index</span>
<span class="w">                </span><span class="n">i_meteo</span><span class="o">=</span><span class="n">inv_FFgrid_subgrid_index</span>
<span class="w">                </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;s/m&quot;</span>
<span class="w">                </span><span class="c">!The same for all--------------------</span>
<span class="w">                </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">                </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                        </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">);</span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">meteo_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:,</span><span class="n">i_meteo</span><span class="p">)</span>
<span class="w">                    </span><span class="k">enddo</span>
<span class="k">                enddo</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="w">                </span><span class="c">!The same for all--------------------</span>

<span class="w">                </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_invFF10_file_index</span>
<span class="w">                </span><span class="n">i_meteo</span><span class="o">=</span><span class="n">inv_FF10_subgrid_index</span>
<span class="w">                </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;s/m&quot;</span>
<span class="w">                </span><span class="c">!The same for all--------------------</span>
<span class="w">                </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">                </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                        </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">);</span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">meteo_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:,</span><span class="n">i_meteo</span><span class="p">)</span>
<span class="w">                    </span><span class="k">enddo</span>
<span class="k">                enddo</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="w">                </span><span class="c">!The same for all--------------------</span>

<span class="w">            </span><span class="k">endif</span>

<span class="k">        endif</span>

<span class="w">        </span><span class="c">!Deallocate the averaging arrays with each receptor grid</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">use_multiple_receptor_grids_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">..</span><span class="nb">not</span><span class="p">.</span><span class="n">use_single_time_loop_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">save_netcdf_average_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">val_array_av</span><span class="p">))</span><span class="w"> </span><span class="k">deallocate</span><span class="p">(</span><span class="n">val_array_av</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">time_seconds_output_av</span><span class="p">))</span><span class="w"> </span><span class="k">deallocate</span><span class="p">(</span><span class="n">time_seconds_output_av</span><span class="p">)</span>
<span class="w">            </span><span class="n">counter_av</span><span class="o">=</span><span class="mi">0</span>
<span class="w">        </span><span class="k">endif</span>


<span class="k">    end subroutine </span><span class="n">uEMEP_save_netcdf_control</span>
</pre></div>

    </section>
    <br>
    
    </div>
  </div>

      <hr>
    </div> <!-- /container -->
    <footer>
      <div class="container">
        <div class="row justify-content-between">
          <div class="col">
            <p>
              uEMEP
              &copy; 2024 
</p>
          </div>
          <div class="col">
            <p class="text-end">
              Documentation generated by
              <a href="https://github.com/Fortran-FOSS-Programmers/ford">FORD</a>
            </p>
          </div>
        </div>
        <br>
      </div> <!-- /container -->
    </footer>

    <!-- Bootstrap core JavaScript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>    

    <!-- MathJax JavaScript
             ================================================== -->
             <!-- Placed at the end of the document so the pages load faster -->
        <script type="text/x-mathjax-config">
          MathJax.Hub.Config({
          TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
          jax: ['input/TeX','input/MathML','output/HTML-CSS'],
          extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
          });
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

          <script src="../tipuesearch/tipuesearch_content.js"></script>
          <script src="../tipuesearch/tipuesearch_set.js"></script>
          <script src="../tipuesearch/tipuesearch.js"></script>

  </body>
</html>